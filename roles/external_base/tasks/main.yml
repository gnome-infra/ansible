---
- name: set root ssh keys
  ansible.builtin.copy:
    src: root_authorized_keys
    dest: /root/.ssh/authorized_keys
    owner: root
    group: root
    mode: 0600

- name: Clear any existing APT lock and repair dpkg
  when: ansible_distribution == "Ubuntu"
  block:
    - name: Identify and terminate the process holding the lock
      ansible.builtin.shell: |
        LOCK_PID=$(fuser -k -9 /var/lib/apt/lists/lock 2>&1 | awk '/killed/ {print $NF}')
        echo "Killed PID: ${LOCK_PID}"
      register: fix_kill_result
      ignore_errors: true
      changed_when: fix_kill_result.rc != 0

- include_tasks: firewalld.yml
  when: skip_firewalld is undefined

- include_tasks: ubuntu.yml
  when: ansible_distribution == "Ubuntu"

- include_tasks: fedora.yml
  when: ansible_distribution == "Fedora"
